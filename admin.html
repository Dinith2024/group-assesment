<!DOCTYPE html>
<html>
<head>
<title>Admin - Order Management</title>
<link rel="stylesheet" href="style.css">
<style>
.admin-container {
    padding: 40px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,.1);
    text-align: center;
}

.stat-card h3 {
    margin: 0 0 10px 0;
    color: #667eea;
    font-size: 32px;
}

.stat-card p {
    margin: 0;
    color: #666;
}

.orders-table {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,.1);
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #667eea;
    color: white;
    padding: 15px;
    text-align: left;
}

td {
    padding: 15px;
    border-bottom: 1px solid #eee;
}

tr:hover {
    background: #f5f5f5;
}

.status-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}

.status-pending { background: #ffd700; color: #333; }
.status-confirmed { background: #4CAF50; color: white; }
.status-preparing { background: #2196F3; color: white; }
.status-out_for_delivery { background: #FF9800; color: white; }
.status-delivered { background: #8BC34A; color: white; }
.status-cancelled { background: #f44336; color: white; }

.status-select {
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

.refresh-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 20px;
}

.refresh-btn:hover {
    background: #5568d3;
}
</style>
</head>
<body>
<header>
<a href="index.html" class="logo">üçî Foods for you</a>
<nav>
<a href="index.html">Home</a>
<a href="menu.html">Menu</a>
<a href="admin.html">Admin</a>
</nav>
</header>

<div class="admin-container">
<div class="admin-header">
<h1>üìä Order Management Dashboard</h1>
<p>Manage and track all orders</p>
</div>

<button class="refresh-btn" onclick="loadOrders()">üîÑ Refresh Orders</button>

<div class="stats-grid" id="statsGrid">
<!-- Stats will be loaded here -->
</div>

<div class="orders-table">
<table>
<thead>
<tr>
<th>Order ID</th>
<th>Customer</th>
<th>Item</th>
<th>Quantity</th>
<th>Total Price</th>
<th>Status</th>
<th>Payment</th>
<th>Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="ordersTableBody">
<tr><td colspan="9" style="text-align: center;">Loading orders...</td></tr>
</tbody>
</table>
</div>
</div>

<script>
const API_BASE_URL = 'http://localhost:3000/api';

// Load statistics
async function loadStats() {
    try {
        const response = await fetch(`${API_BASE_URL}/stats`);
        const result = await response.json();
        
        if (result.success) {
            const stats = result.data;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <h3>${stats.totalOrders}</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card">
                    <h3>Rs.${stats.totalRevenue.toLocaleString()}</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.ordersByStatus.pending}</h3>
                    <p>Pending Orders</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.ordersByStatus.delivered}</h3>
                    <p>Delivered</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Load all orders
async function loadOrders() {
    try {
        const response = await fetch(`${API_BASE_URL}/orders`);
        const result = await response.json();
        
        if (result.success && result.data) {
            displayOrders(result.data);
        } else {
            document.getElementById('ordersTableBody').innerHTML = 
                '<tr><td colspan="9" style="text-align: center;">No orders found</td></tr>';
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTableBody').innerHTML = 
            '<tr><td colspan="9" style="text-align: center; color: red;">Unable to connect to server</td></tr>';
    }
}

function displayOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No orders found</td></tr>';
        return;
    }
    
    // Sort by date (newest first)
    orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    tbody.innerHTML = orders.map(order => {
        const date = new Date(order.createdAt).toLocaleString();
        return `
            <tr>
                <td>#${order.id}</td>
                <td>${order.customerName}<br><small>${order.customerPhone}</small></td>
                <td>${order.item}</td>
                <td>${order.quantity}</td>
                <td>Rs.${order.totalPrice}</td>
                <td>
                    <select class="status-select" onchange="updateStatus(${order.id}, this.value)">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                        <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                        <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                </td>
                <td>${order.paymentMethod}</td>
                <td><small>${date}</small></td>
                <td>
                    <button onclick="deleteOrder(${order.id})" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

// Update order status
async function updateStatus(orderId, newStatus) {
    try {
        const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const result = await response.json();
        if (result.success) {
            loadOrders();
            loadStats();
        } else {
            alert('Failed to update status: ' + result.error);
        }
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update order status');
    }
}

// Delete order
async function deleteOrder(orderId) {
    if (!confirm('Are you sure you want to delete this order?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            loadOrders();
            loadStats();
        } else {
            alert('Failed to delete order: ' + result.error);
        }
    } catch (error) {
        console.error('Error deleting order:', error);
        alert('Failed to delete order');
    }
}

// Load data when page loads
loadStats();
loadOrders();

// Auto-refresh every 30 seconds
setInterval(() => {
    loadStats();
    loadOrders();
}, 30000);
</script>

</body>
<footer>
    <div class="footer-content">
        <div class="footer-section">
            <h3>Foods for you</h3>
            <p>Delivering fresh meals to your door.</p>
        </div>
        <div class="footer-section">
            <h4>Contact Us</h4>
            <p>Email: foddsforyou@gmail.com</p>
            <p>Phone: 011 2233445</p>
        </div>
        <div class="footer-section">
            <h4>Quick Links</h4>
            <a href="contact-us.html">Contact Us</a><br>
            <a href="about-us.html">About Us</a>
        </div>
    </div>
    <div class="footer-bottom">Foods for you</div>
</footer>
</html>
